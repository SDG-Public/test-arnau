{
	"name": "DF_ASJ_FACT_ODS_OBLIGACIO_ECONOM",
	"properties": {
		"folder": {
			"name": "ASJ"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "ODS_ASJ_FACT_TRAMIT",
						"type": "DatasetReference"
					},
					"name": "ODSFactTramit"
				},
				{
					"dataset": {
						"referenceName": "ODS_ASJ_DIM_METADA",
						"type": "DatasetReference"
					},
					"name": "ODSDimMetadata"
				},
				{
					"dataset": {
						"referenceName": "ODS_ASJ_DIM_TIPUS_METADATA",
						"type": "DatasetReference"
					},
					"name": "ODSDimTipusMetadata"
				},
				{
					"dataset": {
						"referenceName": "ODS_ASJ_DIM_OBJECTE_REF_PERSONA",
						"type": "DatasetReference"
					},
					"name": "ODSDimObjecteRefEPersona"
				},
				{
					"dataset": {
						"referenceName": "ODS_ASJ_DIM_PERSONA",
						"type": "DatasetReference"
					},
					"name": "ODSDimPersona"
				},
				{
					"dataset": {
						"referenceName": "ODS_ASJ_DIM_OBJECTE_AGRUPAT",
						"type": "DatasetReference"
					},
					"name": "ODSDimObjecteAgrupat"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "ODS_ASJ_FACT_OBLIGACIO_ECON",
						"type": "DatasetReference"
					},
					"name": "ODSFactObligacioEconomica"
				}
			],
			"transformations": [
				{
					"name": "JoinPaso0"
				},
				{
					"name": "TramitDada"
				},
				{
					"name": "Paso2"
				},
				{
					"name": "FiltroIDTIPUSTRAMIT89"
				},
				{
					"name": "JoinDescTIPUSDADAID"
				},
				{
					"name": "QuitarCamposJoin"
				},
				{
					"name": "UnirCamposEnTemp"
				},
				{
					"name": "QuitarCamposdeTemp"
				},
				{
					"name": "Pivotar"
				},
				{
					"name": "RenombrarTEMP"
				},
				{
					"name": "JoinAuxiliar"
				},
				{
					"name": "JoinMetadata"
				},
				{
					"name": "JoinObjecteRefPersona"
				},
				{
					"name": "JoinDimPersona"
				},
				{
					"name": "FiltreTipusDada25"
				},
				{
					"name": "JoinPaso4"
				},
				{
					"name": "QuitarCampos"
				},
				{
					"name": "FiltroTipusDadaID"
				},
				{
					"name": "QuitarCampos3"
				},
				{
					"name": "AuxiliarQuitarCampos"
				},
				{
					"name": "FiltraCampos"
				},
				{
					"name": "ConcatNombres"
				},
				{
					"name": "TratamientoNulos"
				},
				{
					"name": "FiltreTipusDada17"
				},
				{
					"name": "join1"
				},
				{
					"name": "TratamientoNulos2"
				},
				{
					"name": "FiltraCampos2"
				},
				{
					"name": "CambioTiposDatos"
				}
			],
			"scriptLines": [
				"source(output(",
				"          ID_TRAMIT as decimal(10,0),",
				"          ID_TIPUS_TRAMIT as integer,",
				"          ID_EXPEDIENT as decimal(10,0),",
				"          DESC_OBSERVACIONS as string,",
				"          DESC_NOM_LLIURE as string,",
				"          DATA_TRAMIT as timestamp,",
				"          FLAG_ESTAT as decimal(10,0),",
				"          FLAG_URGENT as decimal(1,0),",
				"          DATA_TANCAMENT as date,",
				"          DATA_INSERT as timestamp,",
				"          DATA_MODIFICACIO as timestamp",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     format: 'table') ~> ODSFactTramit",
				"source(output(",
				"          ID_METADATA as decimal(10,0),",
				"          ID_EXPEDIENT as decimal(10,0),",
				"          ID_TRAMIT as decimal(10,0),",
				"          ID_OBJECTE_AGRUP as decimal(10,0),",
				"          ID_TIPUS_METADATA as decimal(10,0),",
				"          DESC_TIPUS_METADATA as string,",
				"          DESC_METADATA as string,",
				"          METADATA_LITERAL as string,",
				"          METADATA_DATA as timestamp,",
				"          METADATA_ENUMERAT as string,",
				"          METADATA_DECIMAL as double,",
				"          METADATA_NUMERIC as decimal(10,0),",
				"          METADATA_BOOL as decimal(1,0),",
				"          POSICIO as decimal(10,0)",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     format: 'table') ~> ODSDimMetadata",
				"source(output(",
				"          ID_TIPUS_METADATA as decimal(10,0),",
				"          NUM_TIPUS_CAMP as decimal(10,0),",
				"          DESC_NOM as string,",
				"          FLAG_OBLIGATORIA as decimal(1,0),",
				"          FLAG_BAIXA as decimal(1,0)",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     format: 'table') ~> ODSDimTipusMetadata",
				"source(output(",
				"          ID_OBJECTE_REFERENCIA as decimal(10,0),",
				"          ID_IDENTIFICADOR_EXTERN as decimal(10,0),",
				"          ID_DADA as decimal(10,0),",
				"          FLAG_POSICIO as decimal(10,0)",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     format: 'table') ~> ODSDimObjecteRefEPersona",
				"source(output(",
				"          ID_PERSONA as decimal(10,0),",
				"          DESC_NOM as string,",
				"          DESC_COGNOM1 as string,",
				"          DESC_COGNOM2 as string,",
				"          DESC_NOM_SENCER as string,",
				"          ID_TIPUS_PERSONA as decimal(10,0),",
				"          FLAG_ELEGIBLE as decimal(1,0)",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     format: 'table') ~> ODSDimPersona",
				"source(output(",
				"          ID_OBJECTE_AGRUPAT as decimal(10,0),",
				"          ID_METADATA as decimal(10,0),",
				"          POSICIO as decimal(10,0)",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     format: 'table') ~> ODSDimObjecteAgrupat",
				"ODSFactTramit, ODSDimMetadata join(ODSFactTramit@ID_TRAMIT == ODSDimMetadata@ID_TRAMIT,",
				"     joinType:'inner',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> JoinPaso0",
				"FiltroIDTIPUSTRAMIT89 select(mapColumn(",
				"          ID_TRAMIT = ODSFactTramit@ID_TRAMIT,",
				"          ID_TIPUS_TRAMIT,",
				"          ID_EXPEDIENT = ODSFactTramit@ID_EXPEDIENT,",
				"          DESC_OBSERVACIONS,",
				"          DESC_NOM_LLIURE,",
				"          DATA_TRAMIT,",
				"          FLAG_ESTAT,",
				"          FLAG_URGENT,",
				"          DATA_INSERT,",
				"          DATA_MODIFICACIO,",
				"          ID_METADATA,",
				"          ID_EXPEDIENT = ODSDimMetadata@ID_EXPEDIENT,",
				"          ID_TRAMIT = ODSDimMetadata@ID_TRAMIT,",
				"          ID_OBJECTE_AGRUP,",
				"          ID_TIPUS_METADATA,",
				"          DESC_TIPUS_METADATA,",
				"          DESC_METADATA,",
				"          METADATA_LITERAL,",
				"          METADATA_DATA,",
				"          METADATA_ENUMERAT,",
				"          METADATA_DECIMAL,",
				"          METADATA_NUMERIC,",
				"          METADATA_BOOL,",
				"          POSICIO,",
				"          DATA_TANCAMENT",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> TramitDada",
				"TramitDada filter(ID_TIPUS_METADATA == 27) ~> Paso2",
				"JoinPaso0 filter(ID_TIPUS_TRAMIT==89) ~> FiltroIDTIPUSTRAMIT89",
				"TramitDada, ODSDimTipusMetadata join(TramitDada@ID_TIPUS_METADATA == ODSDimTipusMetadata@ID_TIPUS_METADATA,",
				"     joinType:'left',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> JoinDescTIPUSDADAID",
				"JoinDescTIPUSDADAID select(mapColumn(",
				"          ID_TRAMIT,",
				"          ID_TIPUS_TRAMIT,",
				"          ID_EXPEDIENT,",
				"          DESC_OBSERVACIONS,",
				"          DESC_NOM_LLIURE,",
				"          DATA_TRAMIT,",
				"          FLAG_ESTAT,",
				"          FLAG_URGENT,",
				"          DATA_INSERT,",
				"          DATA_MODIFICACIO,",
				"          ID_METADATA,",
				"          ID_OBJECTE_AGRUP,",
				"          ID_TIPUS_METADATA = TramitDada@ID_TIPUS_METADATA,",
				"          DESC_METADATA,",
				"          METADATA_LITERAL,",
				"          METADATA_DATA,",
				"          METADATA_ENUMERAT,",
				"          METADATA_DECIMAL,",
				"          METADATA_NUMERIC,",
				"          METADATA_BOOL,",
				"          POSICIO,",
				"          ID_TIPUS_METADATA = ODSDimTipusMetadata@ID_TIPUS_METADATA,",
				"          DESC_TIPUS_METADATA = DESC_NOM,",
				"          DATA_TANCAMENT",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> QuitarCamposJoin",
				"QuitarCamposJoin derive(TEMP = iif(not(isNull(METADATA_DATA)),toString(METADATA_DATA),iif(not(isNull(METADATA_LITERAL)),toString(METADATA_LITERAL),iif(not(isNull(METADATA_ENUMERAT)),toString(METADATA_ENUMERAT),toString(null()))))) ~> UnirCamposEnTemp",
				"UnirCamposEnTemp select(mapColumn(",
				"          ID_TRAMIT,",
				"          ID_TIPUS_TRAMIT,",
				"          ID_EXPEDIENT,",
				"          DESC_OBSERVACIONS,",
				"          DESC_NOM_LLIURE,",
				"          DATA_TRAMIT,",
				"          FLAG_ESTAT,",
				"          FLAG_URGENT,",
				"          DATA_INSERT,",
				"          DATA_MODIFICACIO,",
				"          ID_METADATA,",
				"          ID_OBJECTE_AGRUP,",
				"          ID_TIPUS_METADATA,",
				"          DESC_TIPUS_METADATA,",
				"          DESC_METADATA,",
				"          METADATA_DECIMAL,",
				"          METADATA_NUMERIC,",
				"          METADATA_BOOL,",
				"          TEMP,",
				"          DATA_TANCAMENT",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> QuitarCamposdeTemp",
				"QuitarCampos3 pivot(groupBy(ID_TRAMIT,",
				"          ID_TIPUS_TRAMIT,",
				"          ID_EXPEDIENT,",
				"          DESC_OBSERVACIONS,",
				"          DESC_NOM_LLIURE,",
				"          DATA_TRAMIT,",
				"          FLAG_ESTAT,",
				"          FLAG_URGENT,",
				"          DATA_INSERT,",
				"          DATA_MODIFICACIO,",
				"          ID_OBJECTE_AGRUP,",
				"          DESC_METADATA,",
				"          DATA_TANCAMENT),",
				"     pivotBy(DESC_TIPUS_METADATA, ['Persones interessades', 'Data sol·licitud', 'UNITAT', 'TIPOLOGIA', 'Classificació tipologia', 'Data pagament parcial', 'Data pagament import estimat', 'Número expedient', 'Import estimat_1', 'Import pagament parcial_1', 'Import pendent_1', 'Import reclamat_1']),",
				"     TEMP = max(TEMP),",
				"     columnNaming: '$N$V',",
				"     lateral: true) ~> Pivotar",
				"Pivotar select(mapColumn(",
				"          ID_TRAMIT,",
				"          ID_TIPUS_TRAMIT,",
				"          ID_EXPEDIENT,",
				"          DESC_OBSERVACIONS,",
				"          DESC_NOM_LLIURE,",
				"          DATA_TRAMIT,",
				"          FLAG_ESTAT,",
				"          FLAG_URGENT,",
				"          DATA_INSERT,",
				"          DATA_MODIFICACIO,",
				"          ID_OBJECTE_AGRUP,",
				"          DESC_METADATA,",
				"          DESC_PERSONES_INTERESSADES = {TEMPPersones interessades},",
				"          DATA_SOLICITUD = {TEMPData sol·licitud},",
				"          DESC_UNITAT = TEMPUNITAT,",
				"          DESC_TIPOLOGIA = TEMPTIPOLOGIA,",
				"          DESC_CLASSIFICACIO_TIPOLOGIA = {TEMPClassificació tipologia},",
				"          DATA_PAGAMENT_PARCIAL = {TEMPData pagament parcial},",
				"          DATA_PAGAMENT_IMPORT_ESTIMAT = {TEMPData pagament import estimat},",
				"          COD_NUMERO_EXPEDIENT = {TEMPNúmero expedient},",
				"          NUM_IMPORT_ESTIMAT = {TEMPImport estimat_1},",
				"          NUM_PAGAMENT_PARCIAL = {TEMPImport pagament parcial_1},",
				"          NUM_IMPORT_PENDENT = {TEMPImport pendent_1},",
				"          NUM_IMPORT_RECLAMAT = {TEMPImport reclamat_1},",
				"          DATA_TANCAMENT",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> RenombrarTEMP",
				"ODSDimObjecteAgrupat, AuxiliarQuitarCampos join(ODSDimObjecteAgrupat@ID_METADATA == AuxiliarQuitarCampos@ID_METADATA,",
				"     joinType:'inner',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> JoinAuxiliar",
				"JoinAuxiliar, ODSDimMetadata join(ID_OBJECTE_AGRUPAT == ID_OBJECTE_AGRUP",
				"     && ODSDimObjecteAgrupat@POSICIO == ODSDimMetadata@POSICIO,",
				"     joinType:'inner',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> JoinMetadata",
				"FiltreTipusDada25, ODSDimObjecteRefEPersona join(ODSDimMetadata@ID_METADATA == ID_DADA,",
				"     joinType:'inner',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> JoinObjecteRefPersona",
				"JoinObjecteRefPersona, ODSDimPersona join(ID_IDENTIFICADOR_EXTERN == ID_PERSONA,",
				"     joinType:'inner',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> JoinDimPersona",
				"JoinMetadata filter(ID_TIPUS_METADATA == 25) ~> FiltreTipusDada25",
				"RenombrarTEMP, FiltraCampos2 join(RenombrarTEMP@ID_TRAMIT == FiltraCampos2@ID_TRAMIT,",
				"     joinType:'left',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> JoinPaso4",
				"JoinPaso4 select(mapColumn(",
				"          ID_TRAMIT = RenombrarTEMP@ID_TRAMIT,",
				"          ID_TIPUS_TRAMIT,",
				"          ID_EXPEDIENT,",
				"          COD_NUMERO_EXPEDIENT,",
				"          NUM_IMPORT_ESTIMAT,",
				"          NUM_IMPORT_PENDENT,",
				"          NUM_IMPORT_RECLAMAT,",
				"          NUM_PAGAMENT_PARCIAL,",
				"          DESC_NOM_SENCER,",
				"          DESC_TIPUS_PERSONA_INTERESADA,",
				"          DESC_UNITAT,",
				"          DESC_TIPOLOGIA,",
				"          DESC_CLASSIFICACIO_TIPOLOGIA,",
				"          DATA_PAGAMENT_PARCIAL,",
				"          DATA_PAGAMENT_IMPORT_ESTIMAT,",
				"          DATA_ENTRADA = DATA_TRAMIT,",
				"          DATA_TANCAMENT,",
				"          DATA_SOLICITUD,",
				"          DATA_INSERT,",
				"          DATA_MODIFICACIO,",
				"          FLAG_ESTAT",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> QuitarCampos",
				"QuitarCamposdeTemp filter(in([124,125,126,136,27,48,142,140,131,141,139,133],ID_TIPUS_METADATA)) ~> FiltroTipusDadaID",
				"FiltroTipusDadaID select(mapColumn(",
				"          ID_TRAMIT,",
				"          ID_TIPUS_TRAMIT,",
				"          ID_EXPEDIENT,",
				"          DESC_OBSERVACIONS,",
				"          DESC_NOM_LLIURE,",
				"          DATA_TRAMIT,",
				"          FLAG_ESTAT,",
				"          FLAG_URGENT,",
				"          DATA_INSERT,",
				"          DATA_MODIFICACIO,",
				"          ID_OBJECTE_AGRUP,",
				"          DESC_TIPUS_METADATA,",
				"          DESC_METADATA,",
				"          TEMP,",
				"          DATA_TANCAMENT",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> QuitarCampos3",
				"Paso2 select(mapColumn(",
				"          ID_TRAMIT,",
				"          ID_METADATA",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> AuxiliarQuitarCampos",
				"ConcatNombres select(mapColumn(",
				"          ID_TRAMIT = AuxiliarQuitarCampos@ID_TRAMIT,",
				"          DESC_NOM_SENCER",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> FiltraCampos",
				"TratamientoNulos derive(DESC_NOM_SENCER = concat(DESC_NOM,' ',DESC_COGNOM1,' ',DESC_COGNOM2)) ~> ConcatNombres",
				"JoinDimPersona derive(DESC_NOM = iif(isNull(DESC_NOM), ' ', DESC_NOM),",
				"          DESC_COGNOM1 = iif(isNull(DESC_COGNOM1), ' ', DESC_COGNOM1),",
				"          DESC_COGNOM2 = iif(isNull(DESC_COGNOM2), ' ', DESC_COGNOM2)) ~> TratamientoNulos",
				"JoinMetadata filter(ID_TIPUS_METADATA == 17) ~> FiltreTipusDada17",
				"FiltraCampos, FiltreTipusDada17 join(FiltraCampos@ID_TRAMIT == AuxiliarQuitarCampos@ID_TRAMIT,",
				"     joinType:'left',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> join1",
				"join1 derive(DESC_TIPUS_PERSONA_INTERESADA = iif(isNull(METADATA_ENUMERAT),'No Informat',METADATA_ENUMERAT)) ~> TratamientoNulos2",
				"TratamientoNulos2 select(mapColumn(",
				"          ID_TRAMIT = FiltraCampos@ID_TRAMIT,",
				"          DESC_NOM_SENCER,",
				"          DESC_TIPUS_PERSONA_INTERESADA",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> FiltraCampos2",
				"QuitarCampos derive(NUM_IMPORT_ESTIMAT = toDouble(replace(replace(NUM_IMPORT_ESTIMAT,'.',''),',','.')),",
				"          NUM_IMPORT_PENDENT = toDouble(replace(replace(NUM_IMPORT_PENDENT,'.',''),',','.')),",
				"          NUM_IMPORT_RECLAMAT = toDouble(replace(replace(NUM_IMPORT_RECLAMAT,'.',''),',','.')),",
				"          NUM_PAGAMENT_PARCIAL = toDouble(replace(replace(NUM_PAGAMENT_PARCIAL,'.',''),',','.')),",
				"          DATA_PAGAMENT_PARCIAL = toDate(DATA_PAGAMENT_PARCIAL),",
				"          DATA_PAGAMENT_IMPORT_ESTIMAT = toDate(DATA_PAGAMENT_IMPORT_ESTIMAT),",
				"          DATA_SOLICITUD = toDate(DATA_SOLICITUD)) ~> CambioTiposDatos",
				"CambioTiposDatos sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     input(",
				"          ID_TRAMIT as decimal(10,0),",
				"          ID_TIPUS_TRAMIT as integer,",
				"          ID_EXPEDIENT as decimal(10,0),",
				"          COD_NUMERO_EXPEDIENT as string,",
				"          NUM_IMPORT_ESTIMAT as double,",
				"          NUM_IMPORT_PENDENT as double,",
				"          NUM_IMPORT_RECLAMAT as double,",
				"          NUM_PAGAMENT_PARCIAL as double,",
				"          DESC_NOM_SENCER as string,",
				"          DESC_TIPUS_PERSONA_INTERESADA as string,",
				"          DESC_UNITAT as string,",
				"          DESC_TIPOLOGIA as string,",
				"          DESC_CLASSIFICACIO_TIPOLOGIA as string,",
				"          DATA_PAGAMENT_PARCIAL as date,",
				"          DATA_PAGAMENT_IMPORT_ESTIMAT as date,",
				"          DATA_ENTRADA as timestamp,",
				"          DATA_TANCAMENT as date,",
				"          DATA_SOLICITUD as date,",
				"          DATA_INSERT as timestamp,",
				"          DATA_MODIFICACIO as timestamp,",
				"          FLAG_ESTAT as decimal(10,0)",
				"     ),",
				"     deletable:false,",
				"     insertable:true,",
				"     updateable:false,",
				"     upsertable:false,",
				"     recreate:true,",
				"     format: 'table',",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     errorHandlingOption: 'stopOnFirstError') ~> ODSFactObligacioEconomica"
			]
		}
	}
}